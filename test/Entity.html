<html>
	<title>Entity Testbed</title>

	<head>
		<script type="text/javascript" src="../jquery-1.7.min.js"></script>
		<script type="text/javascript" src="../keyboard.js"></script>
		<script type="text/javascript" src="../TileArray.js"></script>
		<script type="text/javascript" src="../ScrollBox.js"></script>
		<script type="text/javascript" src="../Entity.js"></script>
		<script type="text/javascript" src="../Line.js"></script>
<<<<<<< HEAD
		<script type="text/javascript" src="../Shape.js"></script>
		<script type="text/javascript" src="../RayHit.js"></script>
=======
>>>>>>> e81eb59e574eed68dcb0933126393aebbe187df7
		<script type="text/javascript" src="../Vec2.js"></script>
		<script type="text/javascript" src="../mouse.js"></script>		
		<script type="text/javascript">
			var canvas, context;
			
			var test = null;

			var LineTest = function() {
				this.rect = new Entity( 100, 100, 30, 30 );
				this.line = new Line();

				this.lines = [];
				for ( var i = 0; i < 8; i++ ) {
					var angle = Math.PI * 2 / 8 * i;

					this.lines.push( new Line( 200, 200, 200 + 100 * Math.cos( angle ), 200 + 100 * Math.sin( angle ) ) );	
				}
			}

			LineTest.prototype.update = function() {
				this.line.p1 = mouse.start;
				this.line.p2 = mouse.pos;

				context.clearRect( 0, 0, canvas.width, canvas.height );

				context.fillStyle = "red";
				if ( this.rect.rectOverlapsLine( this.line ) ) context.fillStyle = "blue";
				this.rect.drawRect( context );

				context.strokeStyle = "red";
				context.lineWidth = 2;

				this.line.draw( context );

				for ( l in this.lines ) {
					this.drawIntersection( this.line, this.lines[l] );	
				}

				mouseStateUpdater( canvas );
			}

			LineTest.prototype.drawIntersection = function( testline, line ) {
				context.strokeStyle = "red";
			    var inter = line.intersect( testline );
				if ( inter != null ) {
					context.strokeStyle = "blue";
					context.fillRect( inter.x - 5, inter.y - 5, 10, 10 );
				}
				line.draw( context );
			}

<<<<<<< HEAD
			var ShapeTest = function() {
				this.shapes = [];

				for ( var i = 0; i < 5; i++ ) {
					this.shapes.push( new Shape().Rectangle( Math.random() * 300, Math.random() * 300, Math.random() * 100, Math.random() * 100 ) );
				}

				for ( var i = 0; i < 5; i++ ) {
					var numPoints = 2 + Math.random() * 4
					var points = [];

					for ( var j = 0; j < numPoints; j++ ) {
						points.push( new Vec2( Math.random() * 300, Math.random() * 300 ) );
					}

					this.shapes.push( new Shape().Loop( points ) );
				}

				this.line = new Line();
			}

			ShapeTest.prototype.update = function() {
				this.line.p1 = mouse.start;
				this.line.p2 = mouse.pos;

				var closestPoints = [];

				for ( s in this.shapes ) {
					var points = this.shapes[s].intersect( this.line );

					// Grab the closest intersection if there was one;
					if ( points.length > 0 ) closestPoints.push( points[0] );
				}

				var t = this; // Can't use "this" inside the sorting function below

				// Sort the list of per-shape closest points to find the overall closest one
				closestPoints.sort( function( a, b ) { return Math.abs( a.x - t.line.p1.x ) - Math.abs( b.x - t.line.p1.x ) } );

				context.clearRect( 0, 0, canvas.width, canvas.height );

				context.strokeStyle = "red";
				context.lineWidth = 2;

				this.line.draw( context );
				for ( s in this.shapes ) {
					var points = this.shapes[s].intersect( this.line );

					context.fillStyle = "blue";
					for ( p in points ) {	
						context.fillRect( points[p].x - 5, points[p].y - 5, 10, 10 );
						context.fillStyle = "red";
					}

					this.shapes[s].draw( context );
				}

				if ( closestPoints.length > 0 ) {
					context.fillStyle = "green";
					context.fillRect( closestPoints[0].x - 5, closestPoints[0].y - 5, 10, 10 );
				}

				mouseStateUpdater( canvas );
			}

			var RayTest = function() {
				this.shapes = [];

				for ( var i = 0; i < 5; i++ ) {
					this.shapes.push( new Shape().Rectangle( Math.random() * 300, Math.random() * 300, Math.random() * 100, Math.random() * 100 ) );
				}

				for ( var i = 0; i < 5; i++ ) {
					var numPoints = 2 + Math.random() * 4
					var points = [];

					for ( var j = 0; j < numPoints; j++ ) {
						points.push( new Vec2( Math.random() * 300, Math.random() * 300 ) );
					}

					this.shapes.push( new Shape().Loop( points ) );
				}

				this.line = new Line();
			}

			RayTest.prototype.update = function() {
				this.line.p1 = mouse.start;
				this.line.p2 = mouse.pos;

				var closestRayHits = [];

				for ( s in this.shapes ) {
					var rayHits = this.shapes[s].rayIntersect( this.line );

					// Grab the closest intersection if there was one;
					if ( rayHits.length > 0 ) closestRayHits.push( rayHits[0] );
				}

				var t = this; // Can't use "this" inside the sorting function below

				// Sort the list of per-shape closest points to find the overall closest one
				closestRayHits.sort( function( a, b ) { return Math.abs( a.point.x - t.line.p1.x ) - Math.abs( b.point.x - t.line.p1.x ) } );

				context.clearRect( 0, 0, canvas.width, canvas.height );

				context.strokeStyle = "red";
				context.lineWidth = 2;

				this.line.draw( context );
				for ( s in this.shapes ) {
					this.shapes[s].draw( context );
				}

				if ( closestRayHits.length > 0 ) {
					var point = closestRayHits[0].point;
					var normal = closestRayHits[0].normal;

					context.fillStyle = "green";
					context.fillRect( point.x-5, point.y-5, 10, 10 );
					
					context.strokeStyle = "orange";
					context.beginPath();
					context.moveTo( point.x, point.y );
					context.lineTo( point.x+normal.x * 100, point.y+normal.y * 100 );
					context.stroke();
				}

				mouseStateUpdater( canvas );
			}				

=======
>>>>>>> e81eb59e574eed68dcb0933126393aebbe187df7
			$(window).load( function () {
				canvas = document.getElementById( "screen" );
				context = canvas.getContext( "2d" );

<<<<<<< HEAD
				test = new RayTest();
=======
				test = new LineTest();
>>>>>>> e81eb59e574eed68dcb0933126393aebbe187df7

				setInterval( update, 60 );											
			});

			function update() {
				test.update();
			}

		</script>
	</head>
	<body>
		<canvas id="screen" width="640" height="480"></canvas>
	</body>
</html>